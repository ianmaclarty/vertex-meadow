<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title id="title">Vertex Meadow Exporter</title>
    <script src="jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="jszip.min.js" type="text/javascript"></script>
    <script src="FileSaver.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Vertex Meadow Exporter</h1>

    <h2>How to use it</h2>
    <p>
    This tool allows you to export a standalone version of your Vertex Meadow
    level that can be uploaded to your own web server or hosted on somewhere
    like gamejolt or itch.io.
    </p>

    <p>
    To use this tool you first need to click the share button in the editor.
    Then copy the ID of your share (the numbers and letters at the end of the share URL
    after the "?l=" bit) and paste it into the box below.
    For example if your URL is http://www.vertexmeadow.xyz/player.html?l=ca1ff7d54db0480c7818
    then you'd paste ca1ff7d54db0480c7818 into the box below.
    </p>

    <p>
    Then click the Export button and a zip of your level will be generated and downloaded
    (this may take a little while depending on your internet connection speed).
    </p>
    
    <h2>Export form:</h2>
    <label>Share ID:</label><input id="gistid" type="text" width="40"></input>
    <br>
    <button id="export_button">Export</button>
    <br>
    <div id="status"></div>
    <br>

    <h2>More info</h2>
    <p>
    The zip contains an index.html page and some other files. The data.pak file is also a zip
    archive and it contains the exported pngs of your level. It also contains some lua files
    which you might want to play with if you're feeling adventurous.
    Note that the height map is stored in the alpha channel of the pngs, so the images might look
    a bit faded, or even completely transparent, if you open them in an image program.
    </p>

    <p>
    Note also that this export method requires the files be accessed from a web server. They won't 
    work if you just open index.html from your local file system. To generate native builds, 
    first download the latest release of <a href="amulet.xyz">amulet</a> for your OS. Once you've 
    installed amulet, rename the data.pak file to data.zip and unzip it. You should end up with 
    some .lua and .png files. Open a terminal (command prompt in Windows) and change to the 
    directory containing those files (e.g. on Windows type something like 
    "cd C:\Users\Ian\VertexMeadowData"). Then type "amulet export". This will generate native 
    builds for all supported platforms as distributable zip files. Before doing this, you may 
    want to change the project name and author information located in conf.lua. More information 
    can be found in the <a href="http://www.amulet.xyz/doc/#exporting">amulet documentation.</a>
    </p>

    <p>
    Feel free to do whatever you like with your creation, including selling it.
    </p>

    <script type='text/javascript'>

function load_arraybuffer(url, cb) {
    var oReq = new XMLHttpRequest();
    oReq.open("GET", url, true);
    oReq.responseType = "arraybuffer";
    oReq.send();

    oReq.onload = function(oEvent) {
      var arrayBuffer = oReq.response;
      cb(arrayBuffer);
    };
}

function load_text(url, cb) {
    var oReq = new XMLHttpRequest();
    oReq.open("GET", url, true);
    oReq.responseType = "text";
    oReq.send();

    oReq.onload = function(oEvent) {
      var txt = oReq.responseText;
      cb(txt);
    };
}

function all_loaded(files) {
    return files["data.pak"] &&
        files["floor.png64"] &&
        files["floor_detail.png64"] &&
        files["ceiling.png64"] &&
        files["ceiling_detail.png64"] &&
        files["hands.png64"] &&
        files["settings.lua"] &&
        files["amulet.js"] &&
        files["player.html"] &&
        files["jquery-2.1.3.min.js"];
}

function load_gist_file(filename, res, files, on_all_loaded) {
    if (!res.files[filename]) {
        files[filename] = "iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAED0lEQVR4Ae3AMQEAAADCoPVPbQdvKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+A0C8AABWV1sUgAAAABJRU5ErkJggg==";
        if (all_loaded(files)) {
            on_all_loaded(files);
        }
    } else if (res.files[filename].truncated) {
        load_text(res.files[filename].raw_url, function(txt) {
            console.log("loaded " + filename);
            files[filename] = txt;
            if (all_loaded(files)) {
                on_all_loaded(files);
            }
        });
    } else {
        console.log("loaded " + filename);
        files[filename] = res.files[filename].content;
        if (all_loaded(files)) {
            on_all_loaded(files);
        }
    }
}

function load_git_text_file(file, files, on_all_loaded) {
    var url = "https://raw.githubusercontent.com/ianmaclarty/vertex-meadow/gh-pages/" + file;
    load_text(url, function(txt) {
        console.log("loaded " + file);
        files[file] = txt;
        if (all_loaded(files)) {
            on_all_loaded(files);
        }
    });
}

function load_git_bin_file(file, files, on_all_loaded) {
    var url = "https://raw.githubusercontent.com/ianmaclarty/vertex-meadow/gh-pages/" + file;
    load_arraybuffer(url, function(ab) {
        console.log("loaded " + file);
        files[file] = ab;
        if (all_loaded(files)) {
            on_all_loaded(files);
        }
    });
}

function load_gist(id) {
    console.log("loading gist " + id);
    var url = 'https://api.github.com/gists/'+id;
    var files = {};
    function create_export(files) {
        console.log("creating export...");

        var data_zip = new JSZip();
        data_zip.load(files["data.pak"]);
        data_zip.file("floor.png", files["floor.png64"], {base64: true});
        data_zip.file("floor_detail.png", files["floor_detail.png64"], {base64: true});
        data_zip.file("ceiling.png", files["ceiling.png64"], {base64: true});
        data_zip.file("ceiling_detail.png", files["ceiling_detail.png64"], {base64: true});
        data_zip.file("hands.png", files["hands.png64"], {base64: true});
        data_zip.file("settings.lua", files["settings.lua"]);
        var data_base64 = data_zip.generate({});

        var download_zip = new JSZip();
        download_zip.file("data.pak", data_base64, {base64: true});
        download_zip.file("amulet.js", files["amulet.js"]);
        download_zip.file("index.html", files["player.html"]);
        download_zip.file("jquery-2.1.3.min.js", files["jquery-2.1.3.min.js"]);
        var content = download_zip.generate({type:"blob"});
        saveAs(content, "vertex_meadow_level.zip");
        $("#status").text("done");
    }
    load_text(url, function(txt) {
        var res = JSON.parse(txt);
        load_gist_file("floor.png64", res, files, create_export);
        load_gist_file("floor_detail.png64", res, files, create_export);
        load_gist_file("ceiling.png64", res, files, create_export);
        load_gist_file("ceiling_detail.png64", res, files, create_export);
        load_gist_file("hands.png64", res, files, create_export);
        load_gist_file("settings.lua", res, files, create_export);
        load_git_text_file("amulet.js", files, create_export);
        load_git_text_file("player.html", files, create_export);
        load_git_text_file("jquery-2.1.3.min.js", files, create_export);
        load_git_bin_file("data.pak", files, create_export);
    });
}

$("#export_button").click(function() {
    $("#status").text("exporting... please wait");
    load_gist($("#gistid").val());
});

    </script>
  </body>
</html>
